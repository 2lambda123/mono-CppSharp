# Reference: http://www.appveyor.com/docs/appveyor-yml
# Notes:
#   - Indent each level of configuration with 2 spaces. Do not use tabs!

#---------------------------------#
#      general configuration      #
#---------------------------------#

version: 1.0.{build}

branches:
  only:
    - master
  except:
    - gh-pages

#---------------------------------#
#    environment configuration    #
#---------------------------------#

shallow_clone: true

matrix:
  fast_finish: true

platform:
  - x86

configuration:
  - Release

environment:
  VS_VERSION: vs2013
  DEPS_PATH: '%APPVEYOR_BUILD_FOLDER%\deps'
  LLVM_PATH: '%APPVEYOR_BUILD_FOLDER%\deps\llvm'
  BUILD_PATH: '%APPVEYOR_BUILD_FOLDER%\build\%VS_VERSION%'
  ARTIFACT_NAME: '%APPVEYOR_PROJECT_NAME%-%VS_VERSION%-%APPVEYOR_REPO_BRANCH%-%APPVEYOR_BUILD_NUMBER%.zip'

install:
  - appveyor DownloadFile https://dl.dropboxusercontent.com/u/194502/CppSharp/llvm_windows_x86.7z
  - 7z x llvm_windows_x86.7z -o%DEPS_PATH%\llvm -y > nul

build_script:
  - build\premake5.exe --file=build\premake4.lua %VS_VERSION%
  - msbuild %BUILD_PATH%\CppSharp.sln /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll" /verbosity:minimal

#---------------------------------#
#      artifacts configuration    #
#---------------------------------#

after_build:
  - echo 'Preparing artifacts...'
  - 7z a %ARTIFACT_NAME% %BUILD_PATH%\lib\%CONFIGURATION%_x32\*
  - appveyor PushArtifact %ARTIFACT_NAME%

#---------------------------------#
#     deployment configuration    #
#---------------------------------#

deploy:
  release: 'CppSharp'
  description: "Latest successful CI builds of branch 'master'"
  provider: GitHub
  auth_token:
    secure: tSYxyXeLtE0f6ZsXsGaHZEAw5Nj4TcgN/rx8uCfPnRjcE55OLAVn/8WXEiovNXLt
  prerelease: true
  on:
    branch: master
